#include <stdlib.h>
#include "gfx3d.h"
#include "physics.h"

double zbuffer[192*192];

gfx3d_model box;

#define BOX_VERTEX_COUNT 60
#define BOX_FACE_COUNT 30

vertex_in_attrs box_vertices[BOX_VERTEX_COUNT] = {
    /* position, normal, u, v */
    /* bottom cell base */
    { {-0.333333, -1, 1}, {0, 1, 0}, 0, 0 },
    { {-0.333333, -1, 1.333333}, {0, 1, 0}, 0, 0 },
    { {0.333333, -1, 1.333333}, {0, 1, 0}, 0, 0 },
    { {0.333333, -1, 1}, {0, 1, 0}, 0, 0 },

    /* bottom cell left */
    { {-0.333333, -1, 1}, {1, 0, 0}, 0, 0 },
    { {-0.333333, -0.333333, 1}, {1, 0, 0}, 0, 0 },
    { {-0.333333, -0.333333, 1.333333}, {1, 0, 0}, 0, 0 },
    { {-0.333333, -1, 1.333333}, {1, 0, 0}, 0, 0 },

    /* bottom cell right */
    { {0.333333, -1, 1.333333}, {-1, 0, 0}, 0, 0 },
    { {0.333333, -0.333333, 1.333333}, {-1, 0, 0}, 0, 0 },
    { {0.333333, -0.333333, 1}, {-1, 0, 0}, 0, 0 },
    { {0.333333, -1, 1}, {-1, 0, 0}, 0, 0 },

    /* top cell left */
    { {-0.333333, 0.333333, 1}, {1, 0, 0}, 0, 0 },
    { {-0.333333, 1, 1}, {1, 0, 0}, 0, 0 },
    { {-0.333333, 1, 1.333333}, {1, 0, 0}, 0, 0 },
    { {-0.333333, 0.333333, 1.333333}, {1, 0, 0}, 0, 0 },

    /* top cell right */
    { {0.333333, 0.333333, 1.333333}, {-1, 0, 0}, 0, 0 },
    { {0.333333, 1, 1.333333}, {-1, 0, 0}, 0, 0 },
    { {0.333333, 1, 1}, {-1, 0, 0}, 0, 0 },
    { {0.333333, 0.333333, 1}, {-1, 0, 0}, 0, 0 },

    /* top cell top */
    { {-0.333333, 1, 1.333333}, {0, -1, 0}, 0, 0 },
    { {-0.333333, 1, 1}, {0, -1, 0}, 0, 0 },
    { {0.333333, 1, 1}, {0, -1, 0}, 0, 0 },
    { {0.333333, 1, 1.333333}, {0, -1, 0}, 0, 0 },

    /* left cell base */
    { {-1, -0.333333, 1}, {0, 1, 0}, 0, 0 },
    { {-1, -0.333333, 1.333333}, {0, 1, 0}, 0, 0 },
    { {-0.333333, -0.333333, 1.333333}, {0, 1, 0}, 0, 0 },
    { {-0.333333, -0.333333, 1}, {0, 1, 0}, 0, 0 },

    /* left cell left */
    { {-1, -0.333333, 1}, {1, 0, 0}, 0, 0 },
    { {-1, 0.333333, 1}, {1, 0, 0}, 0, 0 },
    { {-1, 0.333333, 1.333333}, {1, 0, 0}, 0, 0 },
    { {-1, -0.333333, 1.333333}, {1, 0, 0}, 0, 0 },

    /* left cell top */
    { {-1, 0.333333, 1.333333}, {0, -1, 0}, 0, 0 },
    { {-1, 0.333333, 1}, {0, -1, 0}, 0, 0 },
    { {-0.333333, 0.333333, 1}, {0, -1, 0}, 0, 0 },
    { {-0.333333, 0.333333, 1.333333}, {0, -1, 0}, 0, 0 },

    /* right cell base */
    { {0.333333, -0.333333, 1}, {0, 1, 0}, 0, 0 },
    { {0.333333, -0.333333, 1.333333}, {0, 1, 0}, 0, 0 },
    { {1, -0.333333, 1.333333}, {0, 1, 0}, 0, 0 },
    { {1, -0.333333, 1}, {0, 1, 0}, 0, 0 },

    /* right cell right */
    { {1, -0.333333, 1.333333}, {-1, 0, 0}, 0, 0 },
    { {1, 0.333333, 1.333333}, {-1, 0, 0}, 0, 0 },
    { {1, 0.333333, 1}, {-1, 0, 0}, 0, 0 },
    { {1, -0.333333, 1}, {-1, 0, 0}, 0, 0 },

    /* right cell top */
    { {0.333333, 0.333333, 1.333333}, {0, -1, 0}, 0, 0 },
    { {0.333333, 0.333333, 1}, {0, -1, 0}, 0, 0 },
    { {1, 0.333333, 1}, {0, -1, 0}, 0, 0 },
    { {1, 0.333333, 1.333333}, {0, -1, 0}, 0, 0 },

    /* centre back */
    { {-0.333333, -1, 1.333333}, {0, 0, -1}, 0, 0 },
    { {-0.333333, 1, 1.333333}, {0, 0, -1}, 0, 0 },
    { {0.333333, 1, 1.333333}, {0, 0, -1}, 0, 0 },
    { {0.333333, -1, 1.333333}, {0, 0, -1}, 0, 0 },

    /* left back */
    { {-1, -0.333333, 1.333333}, {0, 0, -1}, 0, 0 },
    { {-1, 0.333333, 1.333333}, {0, 0, -1}, 0, 0 },
    { {-0.333333, 0.333333, 1.333333}, {0, 0, -1}, 0, 0 },
    { {-0.333333, -0.333333, 1.333333}, {0, 0, -1}, 0, 0 },

    /* right back */
    { {0.333333, -0.333333, 1.333333}, {0, 0, -1}, 0, 0 },
    { {0.333333, 0.333333, 1.333333}, {0, 0, -1}, 0, 0 },
    { {1, 0.333333, 1.333333}, {0, 0, -1}, 0, 0 },
    { {1, -0.333333, 1.333333}, {0, 0, -1}, 0, 0 }
};
vertex_out_attrs box_transformed_vertices[BOX_VERTEX_COUNT];
gfx3d_face box_faces[BOX_FACE_COUNT] = {
    {0, 1, 2}, {0, 2, 3},
    {4, 5, 6}, {4, 6, 7},
    {8, 9, 10}, {8, 10, 11},
    {12, 13, 14}, {12, 14, 15},
    {16, 17, 18}, {16, 18, 19},
    {20, 21, 22}, {20, 22, 23},
    {24, 25, 26}, {24, 26, 27},
    {28, 29, 30}, {28, 30, 31},
    {32, 33, 34}, {32, 34, 35},
    {36, 37, 38}, {36, 38, 39},
    {40, 41, 42}, {40, 42, 43},
    {44, 45, 46}, {44, 46, 47},
    {48, 49, 50}, {48, 50, 51},
    {52, 53, 54}, {52, 54, 55},
    {56, 57, 58}, {56, 58, 59}
};

void physics_init(void) {
    box.vertex_count = BOX_VERTEX_COUNT;
    box.vertices = box_vertices;
    box.transformed_vertices = box_transformed_vertices;
    box.face_count = BOX_FACE_COUNT;
    box.faces = box_faces;
}

void physics_frame(uint32_t *pixels, uint32_t time) {
    mat4 rotate_matrix;
    mat3 normal_rotate_matrix;
    // mat4 projection_matrix;

    gfx_cls(pixels, 0x00000000);
    gfx3d_clear_zbuffer(zbuffer);

    mat4_identity(rotate_matrix);
    mat4_to_inverse_transpose_mat3(rotate_matrix, normal_rotate_matrix);

    vec3 light_pos = {0.1, 2, -2};

    gfx3d_gouraud_mesh(pixels, zbuffer, box, rotate_matrix, normal_rotate_matrix, light_pos, 0x00ffff00);
}
